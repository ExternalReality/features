machine:
  timezone:
    America/New_York

  ruby:
    version: 2.3.0

  hosts:
    circlehost: 127.0.0.1
    dev.features.com: 127.0.0.1

dependencies:
  pre:
    - sudo rm -rf /var/cache/apt/archives && sudo ln -s ~/.apt-cache /var/cache/apt/archives && mkdir -p ~/.apt-cache/partial
    - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 575159689BEFB442
    - echo 'deb http://download.fpcomplete.com/ubuntu precise main'| sudo tee /etc/apt/sources.list.d/fpco.list
    - sudo apt-get update && sudo apt-get install stack -y
    - cd ${HOME} && wget https://bintray.com/artifact/download/business/maven/flyway-commandline-3.2.1-linux-x64.tar.gz
    - cd ${HOME} && tar -xvf flyway-commandline-3.2.1-linux-x64.tar.gz

  cache_directories:
    - /home/ubuntu/.stack
    - "~/.apt-cache"

  override:
    - stack setup
    - stack install --only-dependencies
    - bundle install:
        timeout: 180
    
database:
  pre:
    - createdb features
    - ${HOME}/flyway-3.2.1/flyway -user=`whoami` migrate

test:
  override:
    - stack build features
    - stack exec features:
        background: true
    - rspec -r rspec_junit_formatter --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml

deployment:
  staging:
    branch: master
    codedeploy:
      features:
        deployment_group: features-deployment-group
